---
title: "Data Prep"
output: github_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gt)
```

This document keeps track of ongoing efforts to understand the datasets. We'll update this as we go along.

## Access

The data can be downloaded from [http://www2.susep.gov.br/menuestatistica/Autoseg/principal.aspx](http://www2.susep.gov.br/menuestatistica/Autoseg/principal.aspx). We'll be using the first half of 2012 to start, since that's the first time period where CSVs (as opposed to MS Access files) are available. The convention we'll use in this repo is that we'll put the uncompressed directory in `data/`, so the path to a file would be, for example, `data/Autoseg2012B/arq_casco_comp.csv`. The uncompressed directory contains the following files:

```
Autoseg2012B/
├── AjudaAutoseg.chm
├── PremReg.csv
├── SinReg.csv
├── arq_casco3_comp.csv
├── arq_casco4_comp.csv
├── arq_casco_comp.csv
├── auto2_grupo.csv
├── auto2_vei.csv
├── auto_cat.csv
├── auto_cau.csv
├── auto_cep.csv
├── auto_cidade.csv
├── auto_cob.csv
├── auto_idade.csv
├── auto_reg.csv
└── auto_sexo.csv
```

From the documentation and Google Translate we have

```
Description of tables:
Main Tables:
arq_casco - contains exposure data, premiums, claims and insured amount for the CASCO overhead, classified by the Key Category Rate / Region / Model / Year / Sex / Age Range;
arq_casco3 - contains exposure data, premiums and claims for the CASCO overhang, classified by the Key Rate Category / CEP / Model / Year key;
arq_casco4 - contains exposure data, premiums and claims for the CASCO overhang, classified by the Key Rate Category / City / Model / Year;
premreg - regional distribution of prizes; and
sinreg - regional distribution of claims.
Auxiliary Tables:
auto2_vei - contains FIPE code and description of each vehicle model, in addition to the group code to which it belongs;
auto2_group - code and description of model groups;
auto_cat - description code of tariff categories;
auto_cau - code and description of causes of accidents;
auto_cep - correlates the CEP with cities and regions of circulation;
auto_cob - code and description of covers;
auto_idade - code and description of age groups;
auto_reg - code and description of regions of circulation;
auto_sexo - code and description of sex (male, female, legal); and
auto_city - code and name of cities.
```

## Policies table

According to the dataset documentation, we'll want to use `arq_casco_comp.csv` since it's the only one with any policyholder characteristics. The first few lines of the table are

```{r, echo = FALSE, message = FALSE}
read_lines("data/Autoseg2012B/arq_casco_comp.csv", n_max = 4)
```

We'll need to understand what each column means before we can properly ingest the data.

## Mapping tables

The data bundle also comes with many auxiliary tables which we'll need for mapping the codes in the policy dataset. Below are excerpts of each of the tables.

```{r, echo = FALSE, include = FALSE}
read_autoseg <- function(file, col_types = NULL) {
  read_delim(file, delim = ";", locale = locale(encoding = "ISO-8859-1"), col_types = col_types)
}

auto_cat <- read_autoseg("data/Autoseg2012B/auto_cat.csv")
auto_cau <- read_autoseg("data/Autoseg2012B/auto_cau.csv")
auto_cep <- read_autoseg("data/Autoseg2012B/auto_cep.csv")
auto_cidade <- read_autoseg("data/Autoseg2012B/auto_cidade.csv")
auto_cob <- read_autoseg("data/Autoseg2012B/auto_cob.csv")
auto_idade <- read_autoseg("data/Autoseg2012B/auto_idade.csv")
auto_reg <- read_autoseg("data/Autoseg2012B/auto_reg.csv")
auto_sexo <- read_autoseg("data/Autoseg2012B/auto_sexo.csv")
auto2_grupo <- read_autoseg("data/Autoseg2012B/auto2_grupo.csv")
auto2_vei <- read_autoseg("data/Autoseg2012B/auto2_vei.csv")
```

### auto_cat

```{r, echo = FALSE}
knitr::kable(auto_cat)
```

### auto_cau

```{r, echo = FALSE}
knitr::kable(auto_cau)
```

### auto_cep

```{r, echo = FALSE}
auto_cep %>%
  head(10) %>%
  knitr::kable()
```

### auto_cidade

```{r, echo = FALSE}
auto_cidade %>%
  head(10) %>%
  knitr::kable()
```

### auto_cob

```{r, echo = FALSE}
knitr::kable(auto_cob)
```

### auto_idade

```{r, echo = FALSE}
auto_idade %>%
  head(10) %>%
  knitr::kable()
```

### auto_reg

```{r, echo = FALSE}
auto_reg %>%
  head(10) %>%
  knitr::kable()
```

### auto_sexo

```{r, echo = FALSE}
knitr::kable(auto_sexo)
```

### auto2_grupo

```{r, echo = FALSE}
auto2_grupo %>%
  head(10) %>%
  knitr::kable()
```

### auto2_vei

```{r, echo = FALSE}
auto2_vei %>%
  head(10) %>%
  knitr::kable()
```